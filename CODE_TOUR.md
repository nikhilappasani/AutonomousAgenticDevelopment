# Code Tour: Autonomous Agentic Development Platform

This document explains the codebase logic to help you recreate the system.

## 1. Core Architecture (`src/agent/`)

### `src/agent/state.py`
**Purpose**: Defines the "Memory" of the agent.
**How it works**:
- Uses `TypedDict` to define a schema (`DevelopmentState`).
- This dictionary is passed between every node in the graph.
- Key fields:
    - `jira_story_id`: The input trigger.
    - `implementation_plan`: Generated by the Planner.
    - `feature_branch`: Tracked git branch.
    - `code_quality_score`: Metrics from QA.
- **Key Concept**: Using `Annotated[List, operator.add]` allows the agent to *accumulate* logs/errors instead of overwriting them at each step.

### `src/agent/workflow.py`
**Purpose**: The "Brain" or Orchestrator.
**How it works**:
- Uses **LangGraph** to define a State Machine.
- **Nodes**: Python functions (async) that perform work.
    - `trigger_handler`: Entry point.
    - `plan`: Calls LLM to decide strict steps.
    - `generate_code`: Core logic.
    - `quality_gate`: Decision point.
- **Edges**: Connect nodes.
    - `workflow.add_edge("plan", "feature_branch")`: Linear flow.
    - `workflow.add_conditional_edges(...)`: Logic flow (e.g., If Quality < 80 -> Loop back to Code; Else -> PR).
- **Compilation**: The graph is compiled into a runnable application served by the LangGraph CLI.

---

## 2. Tool Integration Layer (`src/tools/`)

These modules isolate external API calls from the agent logic.

### `src/tools/llm_tools.py`
**Connects to**: Azure OpenAI (GPT-4o).
**Functionality**:
- `generate_plan()`: Takes raw Jira requirements and outputs a structured Markdown plan.
- **Why separate?**: Allows you to swap models or providers (e.g., Anthropic) without breaking the agent.

### `src/tools/jira_tools.py`
**Connects to**: Atlassian Jira Cloud.
**Functionality**:
- `get_story_details()`: Fetches Title, Description, and Acceptance Criteria.
- **Authentication**: Uses API Token (Basic Auth).
- **Fallback**: Includes "Mock" data key checks to prevent crashing during local dev.

### `src/tools/github_tools.py`
**Connects to**: GitHub API (via `PyGithub`).
**Functionality**:
- `create_branch()`: Creates `feature/XYZ` from `main`.
- `commit_file()`: Writes raw string content to a specific file path in the repo.
- `create_pull_request()`: Opens the PR with specific title/body.

### `src/tools/testing_tools.py`
**Connects to**: Local Shell (`pytest`).
**Functionality**:
- `run_tests()`: Uses `subprocess` to run `pytest` commands.
- **Parsing**: Reads stdout to count passed/failed tests.

---

## 3. Configuration & Execution

### `langgraph.json`
**Purpose**: Configuration for the LangGraph Runtime.
**Key Fields**:
- `graphs`: Maps the API endpoint to your python object (`workflow:compiled_workflow`).
- `dependencies`: Lists pip packages required for the server.

### `.env`
**Purpose**: Secrets management.
**Critical**: NEVER commit this file. contains your API keys.

### `debug_agent.py`
**Purpose**: Local Simulator.
**How it works**:
- Manually initializes the `DevelopmentState` with a fake Jira ID.
- Runs `compiled_workflow.invoke(state)` directly (bypassing the HTTP server).
- Prints events to the console for debugging.

---

## 4. Jira Webhook Setup (Autonomous Mode)

Since LangGraph's local server cannot accept raw Jira webhooks directly, we use a "Shim" server.

### Steps:
1.  **Start the Main Server**:
    ```bash
    langgraph dev --port 2025
    ```

2.  **Start the Shim** (New Terminal):
    ```bash
    python src/webhook_server.py
    ```
    *(Runs on port 8000)*

3.  **Expose the Shim**:
    ```bash
    ngrok http 8000
    ```

4.  **Configure Jira**:
    - URL: `https://<your-ngrok-id>/jira-webhook`
    - Check "Issue Updated" -> "Status".

This Shim translates the dirty Jira JSON into the clean format request needed by the Agent.

## 5. How to Run the Process

1.  **Start the Server**:
    ```bash
    langgraph dev --port 2025
    ```

2.  **Trigger Options**:
    - **Option A (Manual)**: Go to the Studio UI (`localhost:2025`), click "New Run", and pass `{"jira_story_id": "PROJ-123"}`.
    - **Option B (Simulation)**: Run `python debug_agent.py`.
    - **Option C (Real Webhook)**: Move a Jira ticket to "In Progress" (requires setup above).

3.  **Monitor**:
    - Watch the **LangSmith Studio** to see the graph light up as it moves from Plan -> Code -> PR.
